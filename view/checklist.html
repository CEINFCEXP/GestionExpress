{% extends "components/layout.html" %}
{% block title %} Control Checklist {% endblock %}

{% block head %}
    <!-- Incluyendo los estilos de Bootstrap y Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid bg-white shadow-md rounded-lg  mt-0 mb-3">
    <h1 class="text-3xl font-bold text-center mb-3" style="font-size:20px; font-family: 'Century Gothic', sans-serif;" >Gesti√≥n de Checklist Vehiculos CEXP</h1>
    
    <!-- Pantalla General de Pesta√±as -->
    <ul class="nav nav-tabs justify-content-center" id="checklistTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro" type="button" role="tab" style="font-size:14px; font-family: 'Century Gothic', sans-serif;">üìã Registro Checklist</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="fallas-tab" data-bs-toggle="tab" data-bs-target="#fallas" type="button" role="tab" style="font-size:14px; font-family: 'Century Gothic', sans-serif;">‚ö†Ô∏è Consolidado de Fallas</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="vehiculos-tab" data-bs-toggle="tab" data-bs-target="#vehiculos" type="button" role="tab" style="font-size:14px; font-family: 'Century Gothic', sans-serif;">üöó Parametrizaci√≥n Veh√≠culos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reporte-tab" data-bs-toggle="tab" data-bs-target="#reporte" type="button" role="tab" style="font-size:14px; font-family: 'Century Gothic', sans-serif;">üìä Consultas y Reportes</button>
        </li>
    </ul>
    
    <!-- Proceso de carga -->
    <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(20, 20, 20, 0.5); z-index:9999;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; color:white; font-size:18px; font-weight:bold;">
            <img src="/static/images/cargandobi.gif" style="width:150px; height:150px; border-radius: 50%;" alt="Cargando...">
            <p style="margin-top: 10px;">Guardando datos, por favor espere...</p>
        </div>
    </div>

    <!-- Pesta√±a Registro Checklist -->
    <div class="tab-content mt-4" id="checklistTabsContent">
        <div class="tab-pane fade show active form-section" id="registro" role="tabpanel">
            <div class="container-fluid">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
                    <h4 class="fw-bold m-0 text-truncate" style="font-size: 16px; font-family: 'Century Gothic', sans-serif; max-width: 100%;">
                        ¬°Hola, {{ user_session.nombres }} {{ user_session.apellidos }}!
                    </h4>
                    <h4 class="text-primary fw-bold m-0 text-truncate" style="font-size: 16px; font-family: 'Century Gothic', sans-serif; max-width: 100%;">
                        Consulta tu veh√≠culo y Registra Checklist
                    </h4>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <!--<label class="form-label fw-bold mb-0 me-2">Ingrese Placa:</label> -->
                        <div class="position-relative" style="width: 180px;">
                            <input type="text" class="form-control" id="searchPlaca" placeholder="Ingrese la placa..." 
                                oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');">
                            <div id="placaList" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                        </div>
                        <button id="btnConsultar" class="btn btn-primary" style="height: 36px; min-width: 80px; padding: 4px 6px; font-size: 14px;">
                            Consultar
                        </button>
                        <button class="btn btn-secondary" onclick="limpiarConsulta()" style="height: 36px; min-width: 80px; padding: 4px 6px; font-size: 14px;">
                            Limpiar
                        </button>
                    </div>
                </div>                         

                <!-- Campos a Diligenciar por Conductor -->
                <div class="row g-1 align-items-center">
                    <!-- Fecha Hora del Registro-->
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <span style="color: red; font-weight: bold;">*</span> Fecha y Hora:
                        </label>
                        <input type="datetime-local" class="form-control" id="fechaHoraRegistro" required >
                    </div>
    
                    <!-- Inicio Turno -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <span style="color: red; font-weight: bold;">*</span> Inicio Turno:
                        </label>
                        <input type="time" class="form-control" id="inicioTurno" required>
                    </div>
    
                    <!-- Fin Turno -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <span style="color: red; font-weight: bold;">*</span> Fin Turno:
                        </label>
                        <input type="time" class="form-control" id="finTurno" required>
                    </div>
    
                    <!-- Km Od√≥metro -->
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <span style="color: red; font-weight: bold;">*</span> Km Od√≥metro:
                        </label>
                        <input type="number" class="form-control" id="kmOdometro"
                            placeholder="Ingrese Km" required
                            maxlength="10"
                            oninput="this.value = this.value.slice(0, 10);"
                            pattern="\d{1,10}">
                    </div>
    
                    <!-- Observaci√≥n General -->
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Observaci√≥n General:</label>
                        <textarea class="form-control" id="observacionGeneral" rows="1" placeholder="Ingrese observaciones..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Secciones retractiles -->
            <div class="accordion mt-4" id="vehiculoAccordion">
                
                <!-- Datos Generales del Veh√≠culo -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                            <img src="/static/images/camion.png" alt="Icono camion" width="24" height="24" class="me-2">
                            <span>Datos Generales del Veh√≠culo</span>
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#vehiculoAccordion">
                        <div class="accordion-body">
                            <div class="d-flex flex-wrap gap-4">
                                <p class="mb-0"><strong>Tipo de Veh√≠culo:</strong> <span id="tipoVehiculoInfo">-</span></p>
                                <p class="mb-0"><strong>Marca:</strong> <span id="marcaVehiculoInfo">-</span></p>
                                <p class="mb-0"><strong>L√≠nea:</strong> <span id="lineaVehiculoInfo">-</span></p>
                                <p class="mb-0"><strong>Modelo:</strong> <span id="modeloVehiculoInfo">-</span></p>
                            </div>
                        </div>
                    </div>                    
                </div>
                
                <!-- Verificaci√≥n de Documentos -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                            <img src="/static/images/documento.png" alt="Icono Documento" width="24" height="24" class="me-2">
                            <span>Verificaci√≥n de Documentos</span>
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#vehiculoAccordion">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center">
                                <thead style="background-color: #0a6ad1; color: white; text-align: center; font-weight: bold;">
                                    <tr>
                                        <th class="py-1">Tipo</th>
                                        <th class="py-1">Estado</th>
                                        <th class="py-1">Observaci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-documentos">
                                    <!-- Aqu√≠ se insertar√°n los documentos din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Secciones con tabla (Por Grupo, Posici√≥n y Componente) -->
                <h2 class="fw-bold mt-4" style="color: #060d6b; font-size: 18px;">Estado del veh√≠culo</h2>            
                <div class="accordion mt-4" id="vehiculoAccordion">
                    {% for grupo, posiciones in componentes.items() %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ grupo | replace(' ', '') }}">
                            <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ grupo | replace(' ', '') }}">
                                <img src="/static/images/lista.png" alt="Icono lista" width="24" height="24" class="me-2">
                                {{ grupo }}
                            </button>
                        </h2>
                        <div id="collapse{{ grupo | replace(' ', '') }}" class="accordion-collapse collapse" data-bs-parent="#vehiculoAccordion">
                            <div class="table-responsive">
                                <table class="table table-bordered text-center">
                                    <thead style="background-color: #0a6ad1; color: white; text-align: center; font-weight: bold;">
                                        <tr>
                                            <th class="py-1" style="padding: 12px; border: 1px solid #ddd;">Posici√≥n</th>
                                            <th class="py-1" style="padding: 12px; border: 1px solid #ddd;">Componente</th>
                                            <th class="py-1" style="padding: 12px; border: 1px solid #ddd;">Estado</th>
                                            <th class="py-1" style="padding: 12px; border: 1px solid #ddd;">Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for posicion, componentes in posiciones.items() %}
                                        <tr>
                                            <td rowspan="{{ componentes|length }}">{{ posicion }}</td>
                                            {% for componente in componentes %}
                                            <td>{{ componente }}</td>
                                            <td>
                                                <div class="d-flex align-items-center justify-content-center gap-0" style="gap: 2px;">
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="estado_{{ componente.id_componente }}" value="OK"
                                                            style="transform: scale(1.5); margin-right: 5px;">
                                                        <label class="form-check-label fw-bold">OK</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="estado_{{ componente.id_componente }}" value="Falla"
                                                            style="transform: scale(1.5); margin-right: 5px;">>
                                                        <label class="form-check-label fw-bold">Falla</label>
                                                    </div>
                                                </div>                                                                                               
                                            </td>                                            
                                            <td><input type="text" class="form-control"></td>
                                        </tr>
                                        {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Pesta√±a Consolidado de Fallas -->
        <div class="tab-pane fade form-section" id="fallas" role="tabpanel">
            <div class="row mb-3 p-2 border rounded shadow-sm bg-light">
                <!-- Placa -->
                <div class="col-md-2 position-relative">
                    <label class="form-label fw-bold mb-1">Placa:</label>
                    <input type="text" class="form-control form-control-sm" id="buscarPlaca"
                        placeholder="Ej: ABC123"
                        oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');">
                    <div id="placaList" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                </div>

                <!-- Tipo Veh√≠culo -->
                <div class="col-md-2">
                    <label class="form-label fw-bold mb-1">Tipo Veh√≠culo:</label>
                    <input type="text" class="form-control form-control-sm" id="buscarTipoVehiculo"
                        placeholder="Ej: Carro Taller">
                </div>

                <!-- Marca -->
                <div class="col-md-2">
                    <label class="form-label fw-bold mb-1">Marca:</label>
                    <input type="text" class="form-control form-control-sm" id="buscarMarca"
                        placeholder="Ej: Chevrolet">
                </div>

                <!-- L√≠nea -->
                <div class="col-md-2">
                    <label class="form-label fw-bold mb-1">L√≠nea:</label>
                    <input type="text" class="form-control form-control-sm" id="buscarLinea"
                        placeholder="Ej: NHR">
                </div>

                <!-- Modelo -->
                <div class="col-md-2">
                    <label class="form-label fw-bold mb-1">Modelo:</label>
                    <input type="text" class="form-control form-control-sm" id="buscarModelo"
                        placeholder="Ej: 2026">
                </div>

                <!-- Botones -->
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <!-- <button class="btn btn-primary btn-sm w-50" onclick="cargarFallas()">Buscar</button> -->
                    <button class="btn btn-secondary btn-sm w-50" onclick="limpiarFiltros()">Limpiar</button>
                </div>
            </div>

            <!-- Tabla de Veh√≠culos con Fallas -->
            <div class="table-responsive mt-3 shadow-sm rounded" style="border: 2px solid #dee2e6;  max-height: 70vh; overflow-y: auto;">
                <table class="table table-hover table-bordered align-middle mb-0" id="tablaFallas" style="font-size: 14px; font-family: 'Century Gothic', sans-serif;">
                    <thead class="text-center sticky-top" style="background-color: #336ff0; color: white; z-index: 1;">
                        <tr>
                            <th style="width: 60px;"><i class="fas fa-cog"></i></th>
                            <th><i class="fas fa-car"></i> Placa</th>
                            <th><i class="fas fa-list-alt"></i> Tipo Veh√≠culo</th>
                            <th><i class="fas fa-industry"></i> Marca</th>
                            <th><i class="fas fa-stream"></i> L√≠nea</th>
                            <th><i class="fas fa-calendar-alt"></i> Modelo</th>
                            <th><i class="fas fa-exclamation-triangle"></i> Estado</th>
                            <th><i class="fas fa-link"></i> Vinculaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody class="text-center">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pesta√±a Parametizaci√≥n de Veh√≠culos -->
        <div class="tab-pane fade form-section" id="vehiculos" role="tabpanel">
            <div class="row">
                <!-- Secci√≥n Izquierda: Creaci√≥n de Veh√≠culo -->
                <div class="col-lg-5 d-flex flex-column" style="height: 80vh;">
                    <div class="card shadow-sm flex-grow-1 d-flex flex-column">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0" style="font-size: 18px; font-family: 'Century Gothic', sans-serif; color: #ffffff;font-weight: bold;">Registrar Nuevo Veh√≠culo</h4>
                        </div>
                        <div class="card-body flex-grow-1 d-flex flex-column" style="overflow-y: auto; height: 70vh;">
                            <form id="createVehicleForm">
                                <div class="mb-3">
                                    <label class="form-label"><span style="color: red; font-weight: bold;">*</span> Placa del Veh√≠culo:</label>
                                    <input type="text" class="form-control" id="placaVehiculo" placeholder="Ejemplo: ABC123" required 
                                        oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><span style="color: red; font-weight: bold;">*</span> Tipo de Veh√≠culo:</label>
                                    <select class="form-select" id="tipoVehiculo" required>
                                        <option disabled selected>Seleccione el tipo...</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"><span style="color: red; font-weight: bold;">*</span> Marca:</label>
                                    <input type="text" class="form-control" id="marcaVehiculo" placeholder="Ejemplo: Toyota" required>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"><span style="color: red; font-weight: bold;">*</span> L√≠nea:</label>
                                        <input type="text" class="form-control" id="lineaVehiculo" placeholder="Ejemplo: Hilux" required>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label"><span style="color: red; font-weight: bold;">*</span> Modelo:</label>
                                        <input type="number" class="form-control" id="modeloVehiculo" placeholder="Ejemplo: 2022" required
                                            oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');">
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success w-100">Guardar Veh√≠culo</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n Derecha: Listado de Veh√≠culos -->
                <div class="col-lg-7 d-flex flex-column" style="height: 80vh;">
                    <div class="card shadow-sm flex-grow-1 d-flex flex-column">
                        <div class="card-header bg-dark text-white">
                            <h4 class="mb-0" style="font-size: 18px; font-family: 'Century Gothic', sans-serif; color: #ffffff;font-weight: bold;">Veh√≠culos Registrados</h4>
                        </div>
                        <div class="card-body flex-grow-1 d-flex flex-column" style="overflow-y: auto; height: 70vh; padding-top: 0;">
                            <table class="table table-hover table-striped text-center" style="table-layout: fixed; width: 100%; font-size: 12px;">
                                <thead style="background-color: #0a6ad1; color: white; position: sticky; top: 0; z-index: 1; margin-top: 0; padding: 0">
                                    <tr>
                                        <th style="width: 65px; min-width: 65px;">Placa</th>
                                        <th style="width: 80px; min-width:80px;">Tipo</th>
                                        <th style="width: 120px; min-width: 120px;">Marca</th>
                                        <th style="width: 120px; min-width: 120px;">L√≠nea</th>
                                        <th style="width: 75px; min-width: 75px;">Modelo</th>
                                        <th style="width: 80px; min-width: 80px;">Estado</th>
                                        <th style="width: 150px; min-width: 150px;">Acciones</th>
                                    </tr>                                    
                                </thead>
                                <tbody id="vehiculosTable">
                                    <!-- Se cargar√°n los veh√≠culos aqu√≠ din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pesta√±a Reportes -->
        <div class="tab-pane fade" id="reporte" role="tabpanel">
            <div class="container-fluid mt-3">

                <!--  SECCI√ìN DE FILTROS -->
                <div class="filtros-reporte rounded p-3 shadow-sm mb-4 bg-white border-start border-4 border-primary">
                    <h5 class="mb-3" style="font-family: 'Century Gothic'; font-weight: bold; color: #0d6efd;">
                        üîç Filtros del Reporte de Fallas
                    </h5>

                    <div class="row g-2 align-items-end">
                        <!-- Fecha -->
                        <div class="col-md-2">
                            <label class="form-label-sm mb-0">Fecha de Reporte:</label>
                            <input type="date" id="filtroFecha" class="form-control form-control-sm">
                        </div>

                        <!-- Placa -->
                        <div class="col-md-2">
                            <label class="form-label-sm mb-0">Placa:</label>
                            <select id="filtroPlaca" class="form-select form-select-sm">
                                <option value="">Todas</option>
                            </select>
                        </div>

                        <!-- Tipo Veh√≠culo -->
                        <div class="col-md-2">
                            <label class="form-label-sm mb-0">Tipo Veh√≠culo:</label>
                            <select id="filtroTipoVehiculo" class="form-select form-select-sm">
                                <option value="">Todos</option>
                            </select>
                        </div>

                        <!-- Marca -->
                        <div class="col-md-2">
                            <label class="form-label-sm mb-0">Marca:</label>
                            <select id="filtroMarca" class="form-select form-select-sm">
                                <option value="">Todas</option>
                            </select>
                        </div>

                        <!-- Estado -->
                        <div class="col-md-1">
                            <label class="form-label-sm mb-0">Estado:</label>
                            <select id="filtroEstado" class="form-select form-select-sm">
                                <option value="">Todos</option>
                                <option value="Falla">‚ùå Falla</option>
                                <option value="OK">‚úîÔ∏è OK</option>
                            </select>
                        </div>

                        <!-- Registrado por -->
                        <div class="col-md-2">
                            <label class="form-label-sm mb-0">Registrado por:</label>
                            <select id="filtroUsuario" class="form-select form-select-sm">
                                <option value="">Todos</option>
                            </select>
                        </div>

                        <!-- Bot√≥n consultar  -->
                        <div class="col-md-1">
                            <button class="btn btn-primary btn-sm w-100 mt-3" onclick="consultarReporteFallas()">
                                <i class="fas fa-search me-1"></i> Consultar
                            </button>
                        </div>
                    </div>
                </div>

                <!--  SECCI√ìN DE RESULTADOS -->
                <div class="resultados-reporte rounded p-3 shadow-sm bg-light" style="min-height: 450px;">
                    <!-- <h6 class="mb-2" style="font-family: 'Century Gothic'; color: #333;">üìã Resultados del Reporte</h6> -->
                    <div id="contenedorResultados">
                        <!-- Aqu√≠ se cargar√° la tabla despu√©s de consultar -->
                    </div>
                </div>
            <div class="text-end mt-2" id="botonesDescarga" style="display: none;">
                <button class="btn btn-success btn-sm me-1" onclick="descargarReporte('xlsx')">üì• Descargar Excel</button>
                <button class="btn btn-warning btn-sm me-1" onclick="descargarReporte('csv')">üì• Descargar CSV</button>
                <button class="btn btn-info btn-sm" onclick="descargarReporte('json')">üì• Descargar JSON</button>
            </div>                
        </div>
    </div>

<!-- Modal para editar veh√≠culo -->
<div class="modal fade" id="editVehicleModal" tabindex="-1" aria-labelledby="editVehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editVehicleForm">
                <input type="hidden" id="editVehicleIdHidden" name="placa">
  
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editVehicleModalLabel">Editar Veh√≠culo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
  
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editPlacaVehiculo" class="form-label">Placa</label>
                        <input type="text" class="form-control" id="editPlacaVehiculo" name="placa" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="editTipoVehiculo" class="form-label">Tipo de Veh√≠culo</label>
                        <select class="form-select" id="editTipoVehiculo" name="tipo_vehiculo" required>
                            <option disabled selected>Seleccione el tipo...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editMarcaVehiculo" class="form-label">Marca</label>
                        <input type="text" class="form-control" id="editMarcaVehiculo" name="marca" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editLineaVehiculo" class="form-label">L√≠nea</label>
                            <input type="text" class="form-control" id="editLineaVehiculo" name="linea" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editModeloVehiculo" class="form-label">Modelo</label>
                            <input type="number" class="form-control" id="editModeloVehiculo" name="modelo" required>
                        </div>
                    </div>
                </div>
  
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
  </div>

<!-- Modal de Gesti√≥n de Fallas -->
<div class="modal fade" id="modalFalla" tabindex="-1" aria-labelledby="modalFallaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="modalFallaLabel">
                    Detalle de Fallas del Veh√≠culo
                </h5>
                <button type="button" class="btn-close btn-close-white" onclick="cerrarModalFalla()" aria-label="Close"></button>
            </div>

            <div class="modal-body" style="font-size: 14px; font-family: 'Century Gothic', sans-serif;">
                <!-- Encabezado Datos del Veh√≠culo (horizontal) -->
                <div class="border rounded bg-light p-3 mb-3 shadow-sm">
                    <div class="row text-start" style="font-size: 14px;">
                        <div class="col-md-2 mb-2"><strong>Placa:</strong> <span id="fallaPlaca">-</span></div>
                        <div class="col-md-3 mb-2"><strong>Tipo Veh√≠culo:</strong> <span id="fallaTipoVehiculo">-</span></div>
                        <div class="col-md-2 mb-2"><strong>Marca:</strong> <span id="fallaMarca">-</span></div>
                        <div class="col-md-3 mb-2"><strong>L√≠nea:</strong> <span id="fallaLinea">-</span></div>
                        <div class="col-md-2 mb-2"><strong>Modelo:</strong> <span id="fallaModelo">-</span></div>
                    </div>
                </div>
                <!-- Observaciones Generales -->
                <div class="mb-4">
                    <h6 class="bg-secondary text-white p-2 rounded">üìå Observaciones Generales</h6>
                    <div class="table-responsive" style="max-height: 180px; overflow-y: auto; border: 1px solid #dee2e6;">
                        <table class="table table-bordered table-sm mb-0" style="font-size: 13px;">
                            <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                                <tr>
                                    <th style="width: 20%;">Fecha Reporte</th>
                                    <th style="width: 55%;">Observaciones</th>
                                    <th style="width: 25%;">Registrado Por</th>
                                </tr>
                            </thead>
                            <tbody id="tablaObservacionesGenerales">
                                <!-- Aqu√≠ van las filas din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Fallas en Documentos -->
                <div class="mb-4">
                    <h6 class="p-2 rounded text-white" style="background-color: #0078C7;">
                        üìÑ Verificaci√≥n de Documentos (√öltimo Checklist)
                    </h6>                    
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Historial</th>
                                <th>Fecha Reporte</th>
                                <th>Tipo</th>
                                <th>Observaci√≥n</th>
                                <th>Registrado Por</th>
                                <th>Estado</th>
                                <th>Ajuste</th>
                                <th>Observaci√≥n Ajuste</th>
                            </tr>
                        </thead>
                        <tbody id="tablaFallasDocumentos"></tbody>
                    </table>
                </div>

                <!-- Fallas en Componentes -->
                <div>
                    <h6 class="p-2 rounded text-white" style="background-color: #4ea35c;">
                        üîß Verificaci√≥n de Estados del Veh√≠culo (√öltimo Checklist)
                    </h6>                    
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Historial</th>
                                <th>Fecha Reporte</th>
                                <th>Grupo</th>
                                <th>Posici√≥n</th>
                                <th>Componente</th>
                                <th>Observaci√≥n</th>
                                <th>Registrado Por</th>
                                <th>Estado</th>
                                <th>Ajuste</th>
                                <th>Observaci√≥n Ajuste</th>
                            </tr>
                        </thead>
                        <tbody id="tablaFallasComponentes"></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalFalla()">Cerrar</button>
                <button type="button" class="btn btn-success" id="btnGuardarCambiosChecklist" disabled>Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Historial (Din√°mico para Documentos o Componentes) -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content shadow" style="font-size: 13px;">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalHistorialLabel">Historial</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Contenedor con scroll para tabla -->
            <div class="modal-body p-2" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-sm table-bordered mb-0">
                    <thead class="table-light sticky-top" id="historialHeader">
                        <!-- Cabecera din√°mica -->
                    </thead>
                    <tbody id="tablaHistorialBody">
                        <!-- Cuerpo din√°mico -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ###################################################################################### -->
<!-- ###################### INICIO DE LOGICA Y FUNCIONES JAVASCRIPT  ###################### -->
<!-- ###################################################################################### -->

<!--  JavaScript Interacci√≥n Pesta√±as  -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        let tabs = document.querySelectorAll(".nav-tabs .nav-link");

        // Asegurar que la primera pesta√±a est√© activa al inicio
        let firstTab = document.querySelector(".nav-tabs .nav-link");
        if (firstTab) {
            firstTab.classList.add("active");
            firstTab.style.backgroundColor = "#007bff"; // Color de pesta√±a activa
            firstTab.style.color = "#fff";
        }

        tabs.forEach(tab => {
            // Evento para cambiar color al pasar el mouse
            tab.addEventListener("mouseover", function() {
                if (!this.classList.contains("active")) {
                    this.style.backgroundColor = "#d3d3d3";
                    this.style.color = "#000";
                }
            });

            // Evento para restaurar color cuando el mouse sale
            tab.addEventListener("mouseout", function() {
                if (!this.classList.contains("active")) {
                    this.style.backgroundColor = "#f8f9fa";
                    this.style.color = "#495057";
                }
            });

            // Evento para manejar selecci√≥n de pesta√±as
            tab.addEventListener("click", function() {
                tabs.forEach(t => {
                    t.classList.remove("active");
                    t.style.backgroundColor = "#f8f9fa"; // Restaurar color original
                    t.style.color = "#495057";
                });
                this.classList.add("active");
                this.style.backgroundColor = "#007bff"; // Color de pesta√±a activa
                this.style.color = "#fff";
            });
        });
    });
</script>

<!--  JavaScript para Manejo de Registro CheckList  -->
<script>
    // Autocompletar Fecha-Hora al abrir formulario
    document.addEventListener("DOMContentLoaded", function () {
        // Funci√≥n para establecer la fecha y hora actual con la zona horaria de Bogot√°
        function setFechaHoraActual() {
            // Obtener la fecha y hora en la zona horaria de Bogot√°
            const fechaUTC = new Date();
            const opcionesFecha = { timeZone: "America/Bogota", year: "numeric", month: "2-digit", day: "2-digit" };
            const opcionesHora = { timeZone: "America/Bogota", hour: "2-digit", minute: "2-digit", hour12: false };
    
            // Formatear la fecha y hora correctamente
            const fechaBogota = new Intl.DateTimeFormat("es-CO", opcionesFecha).format(fechaUTC);
            const horaBogota = new Intl.DateTimeFormat("es-CO", opcionesHora).format(fechaUTC);
    
            // Convertir la fecha al formato YYYY-MM-DD
            const [dia, mes, anio] = fechaBogota.split("/");
            const fechaFormateada = `${anio}-${mes}-${dia}`;
    
            // Convertir la hora al formato HH:MM
            const horaFormateada = horaBogota.replace(":", ":"); // Asegurar formato HH:MM
    
            // Asignar la fecha y hora al input
            document.getElementById("fechaHoraRegistro").value = `${fechaFormateada}T${horaFormateada}`;
        }
        // Ejecutar la funci√≥n al cargar la p√°gina
        setFechaHoraActual();
    
        // Asegurar que la fecha y hora se actualicen al abrir la pesta√±a de checklist
        const tab = document.getElementById("registro-tab"); // ID correcto del tab
        if (tab) {
            tab.addEventListener("shown.bs.tab", function () {
                setFechaHoraActual();
            });
        }
        // Asegurar que el campo sea obligatorio
        document.getElementById("fechaHoraRegistro").setAttribute("required", "true");
    });       
    
    // Autocompletar placa al digitar por el usuario
    document.getElementById("searchPlaca").addEventListener("input", async function () {
        const query = this.value.trim();
        const placaList = document.getElementById("placaList");
    
        if (query.length < 1) {
            placaList.innerHTML = "";
            return;
        }
    
        const response = await fetch(`/vehiculos/buscar/${query}`);
        const placas = await response.json();
    
        placaList.innerHTML = ""; // Limpiar la lista antes de mostrar nuevas opciones
    
        if (placas.length === 0) {
            placaList.innerHTML = `<button class="list-group-item list-group-item-action disabled">No hay coincidencias</button>`;
            return;
        }
    
        placas.forEach(vehiculo => {
            const item = document.createElement("button");
            item.classList.add("list-group-item", "list-group-item-action");
            item.style.padding = "4px"; 
            item.style.fontSize = "16px"; 
            item.textContent = vehiculo.placa;
            item.addEventListener("click", function () {
                document.getElementById("searchPlaca").value = vehiculo.placa.toUpperCase();
                placaList.innerHTML = ""; // Ocultar la lista tras seleccionar
            });
    
            placaList.appendChild(item);
        });
    });    
    
    // Eventos click o consultas
    document.querySelector(".btn-primary").addEventListener("click", consultarVehiculo);
    document.querySelector(".btn-secondary").addEventListener("click", limpiarConsulta);
    document.addEventListener("DOMContentLoaded", cargarDocumentos);
    
    // Funci√≥n para consultar un veh√≠culo por placa
    async function consultarVehiculo() {
        const placa = document.getElementById("searchPlaca").value.trim();
        if (!placa) {
            alert("Por favor, ingrese una placa v√°lida.");
            return;
        }
    
        try {
            const response = await fetch(`/vehiculos/checklist/${placa}`);
            if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
            
            const data = await response.json();
            
            //console.log(" Respuesta recibida del servidor:", data);
    
            if (data.error) {
                alert("Veh√≠culo no encontrado.");
                return;
            }
    
            const vehiculo = data.vehiculo;
            const checklist = data.checklist || {};
            let documentos = data.documentos || [];
            let detalles = data.detalles || [];
    
            // **Validar documentos y detalles**
            if (!Array.isArray(documentos)) {
                console.warn("‚ö†Ô∏è No se encontraron documentos v√°lidos.");
                documentos = [];
            }
    
            if (!Array.isArray(detalles)) {
                console.warn("‚ö†Ô∏è No se encontraron detalles v√°lidos.");
                detalles = [];
            }
    
            // **Asignar informaci√≥n del veh√≠culo**
            document.getElementById("tipoVehiculoInfo").textContent = vehiculo.tipo_vehiculo;
            document.getElementById("marcaVehiculoInfo").textContent = vehiculo.marca;
            document.getElementById("lineaVehiculoInfo").textContent = vehiculo.linea;
            document.getElementById("modeloVehiculoInfo").textContent = vehiculo.modelo;
            document.getElementById("searchPlaca").setAttribute("data-idVehiculo", vehiculo.id_vehiculo);
    
            // **Cargar los componentes seg√∫n el tipo de veh√≠culo**
            await cargarComponentes(vehiculo.placa);
    
            // **Actualizar los datos del checklist si existe**
            //document.getElementById("fechaHoraRegistro").value = checklist.fecha_hora_registro || "";
            document.getElementById("inicioTurno").value = checklist.inicio_turno || "";
            document.getElementById("finTurno").value = checklist.fin_turno || "";
            document.getElementById("kmOdometro").value = checklist.km_odometro || "";
            document.getElementById("observacionGeneral").value = checklist.observaciones_generales || "";
    
            // **Llenar la tabla de documentos**
            document.querySelectorAll("#tbody-documentos tr").forEach(row => {
                const idTipoDocumento = row.getAttribute("data-idTipoDocumento");
                const index = row.getAttribute("data-index"); 
                const docEncontrado = documentos.find(doc => doc.id_tipo_documento == idTipoDocumento);
            
                if (docEncontrado) {
                    const radioName = `doc_estado_${idTipoDocumento}_${index}`; 
                    const radioOk = row.querySelector(`input[name="${radioName}"][value="OK"]`);
                    const radioFalla = row.querySelector(`input[name="${radioName}"][value="Falla"]`);
                    const observacionInput = row.querySelector("input[type='text']");
            
                    if (radioOk && radioFalla) {
                        const estadoOriginal = docEncontrado.estado ? "OK" : "Falla";
                        radioOk.checked = docEncontrado.estado ? true : false;
                        radioFalla.checked = !docEncontrado.estado ? true : false;
                    
                        radioOk.dataset.originalEstado = estadoOriginal;
                        radioFalla.dataset.originalEstado = estadoOriginal;
                    
                        radioOk.dataset.alreadyWarned = "false";
                        radioFalla.dataset.alreadyWarned = "false";
                    }                    
            
                    if (observacionInput) {
                        observacionInput.value = docEncontrado.observaciones || "";
                    }
                }
            });
    
            // **Actualizar la tabla de detalles del checklist**
            document.querySelectorAll("#vehiculoAccordion tbody tr").forEach(row => {
                const idComponente = row.getAttribute("data-idComponente");
                const detalleEncontrado = detalles.find(det => det.id_componente == idComponente);
    
                if (detalleEncontrado) {
                    const radioOK = row.querySelector(`input[name="comp_estado_${idComponente}"][value="OK"]`);
                    const radioFalla = row.querySelector(`input[name="comp_estado_${idComponente}"][value="Falla"]`);
                
                    if (radioOK && radioFalla) {
                        const estadoOriginal = detalleEncontrado.estado ? "OK" : "Falla";
                        radioOK.checked = detalleEncontrado.estado ? true : false;
                        radioFalla.checked = !detalleEncontrado.estado ? true : false;
                    
                        radioOK.dataset.originalEstado = estadoOriginal;
                        radioFalla.dataset.originalEstado = estadoOriginal;
                    
                        radioOK.dataset.alreadyWarned = "false";
                        radioFalla.dataset.alreadyWarned = "false";
                    }                    
                
                    const observacionInput = row.querySelector("input[type='text']");
                    if (observacionInput) {
                        observacionInput.value = detalleEncontrado.observaciones || "";
                    }
                }                
            });

            activarCambioColorEstado();
            //console.log(" Veh√≠culo y checklist cargados correctamente.");
            
        } catch (error) {
            console.error("‚ùå Error al consultar veh√≠culo:", error);
            alert("Ocurri√≥ un error al consultar el veh√≠culo.");
        }
    }          

    // Borra o limpia la consulta y los datos del veh√≠culo en la pantalla
    function limpiarConsulta() {
        const confirmacion = confirm("¬øEst√° seguro de que desea limpiar todos los datos?");
        
        if (!confirmacion) {
            return; 
        }

        document.getElementById("searchPlaca").value = "";
        document.getElementById("fechaHoraRegistro").value = "";
        document.getElementById("inicioTurno").value = "";
        document.getElementById("finTurno").value = "";
        document.getElementById("kmOdometro").value = "";
        document.getElementById("observacionGeneral").value = "";

        // Limpiar selecci√≥n de radio buttons y campos de texto en Documentos
        document.querySelectorAll("#tbody-documentos input[type='radio']").forEach(radio => {
            radio.checked = false;
        });
        document.querySelectorAll("#tbody-documentos input[type='text']").forEach(input => {
            input.value = "";
        });

        // Limpiar selecci√≥n de radio buttons y campos de texto en Componentes
        document.querySelectorAll("#vehiculoAccordion tbody input[type='radio']").forEach(radio => {
            radio.checked = false;
        });
        document.querySelectorAll("#vehiculoAccordion tbody input[type='text']").forEach(input => {
            input.value = "";
        });

        // Restablecer la colorimetr√≠a de todas las celdas de estado en Documentos
        document.querySelectorAll("#tbody-documentos td").forEach(celda => {
            celda.style.backgroundColor = "transparent"; // Restaura el color a su estado original
        });

        // Restablecer la colorimetr√≠a de todas las celdas de estado en Componentes
        document.querySelectorAll("#vehiculoAccordion tbody td").forEach(celda => {
            celda.style.backgroundColor = "transparent"; // Restaura el color a su estado original
        });

        // limia estado original de los radio buttons
        document.querySelectorAll("input[type='radio']").forEach(radio => {
            delete radio.dataset.originalEstado;
        });
        
    }

    // Funci√≥n para obtener los documentos desde la base de datos y cargarlos en la tabla
    async function cargarDocumentos() {
        try {
            const response = await fetch("/documentos");
            const documentos = await response.json();
    
            if (!Array.isArray(documentos)) {
                console.error("Formato de respuesta incorrecto:", documentos);
                alert("Error al obtener los documentos.");
                return;
            }
    
            const tbody = document.getElementById("tbody-documentos");
            tbody.innerHTML = ""; 
    
            documentos.forEach((doc, index) => {  // Asegurar √≠ndices √∫nicos
                let fila = document.createElement("tr");
    
                // üîπ Asignar el ID real del documento o un valor alternativo
                let idTipoDocumento = doc.id_tipo_documento || doc.id;
                fila.setAttribute("data-idTipoDocumento", idTipoDocumento);
                fila.setAttribute("data-index", index);
    
                // üîπ Generar un nombre √∫nico para cada fila
                let radioName = `doc_estado_${idTipoDocumento}_${index}`; 
    
                fila.innerHTML = `
                    <td>${doc.nombre}</td>
                    <td>
                        <div class="d-flex align-items-center justify-content-center gap-0" style="gap: 2px;">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="${radioName}" value="OK"
                                    style="transform: scale(1.5); margin-right: 5px;">
                                <label class="form-check-label fw-bold">OK</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="${radioName}" value="Falla"
                                    style="transform: scale(1.5); margin-right: 5px;">
                                <label class="form-check-label fw-bold">Falla</label>
                            </div>
                        </div>
                    </td>
                    <td><input type="text" class="form-control"></td>
                `;
    
                tbody.appendChild(fila);
            });
    
        } catch (error) {
            console.error("Error al obtener documentos:", error);
            alert("Ocurri√≥ un error al cargar los documentos.");
        }

        activarCambioColorEstado();
    }                   

    // Funci√≥n para cargar componentes din√°micamente seg√∫n la placa
    async function cargarComponentes(placa) {
        try {
            const response = await fetch(`/componentes/${placa}`);
            const componentes = await response.json();

            if (componentes.error) {
                alert("Error al obtener componentes: " + componentes.error);
                return;
            }

            // Renderizar los componentes en el acorde√≥n
            generarAcordeonComponentes(componentes);

        } catch (error) {
            console.error("Error al obtener componentes:", error);
            alert("Ocurri√≥ un error al obtener los componentes.");
        }
    }

    // Funci√≥n para actualizar din√°micamente el acorde√≥n con los componentes
    function generarAcordeonComponentes(componentes) {
        const acordeon = document.getElementById("vehiculoAccordion");
    
        // Eliminar solo las secciones din√°micas previas
        const gruposDinamicos = acordeon.querySelectorAll(".grupo-dinamico");
        gruposDinamicos.forEach(grupo => grupo.remove());
    
        // üîπ Limpiar todas las selecciones previas antes de volver a generar el acorde√≥n
        document.querySelectorAll("input[type='radio']").forEach(input => {
            input.checked = false;
        });
    
        Object.keys(componentes).forEach(grupo => {
            const listaComponentes = componentes[grupo];
    
            // Agrupar por posici√≥n
            let posicionesAgrupadas = {};
            listaComponentes.forEach((item) => {
                if (!posicionesAgrupadas[item.posicion]) {
                    posicionesAgrupadas[item.posicion] = [];
                }
                posicionesAgrupadas[item.posicion].push({ 
                    componente: item.componente, 
                    id_componente: item.id_componente  
                });
            });
    
            let seccionHTML = document.createElement("div");
            seccionHTML.classList.add("accordion-item", "grupo-dinamico");
    
            seccionHTML.innerHTML = `
                <h2 class="accordion-header" id="heading${grupo.replace(/\s/g, '')}">
                    <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#collapse${grupo.replace(/\s/g, '')}">
                        <img src="/static/images/lista.png" alt="Icono lista" width="24" height="24" class="me-2">
                        ${grupo}
                    </button>
                </h2>
                <div id="collapse${grupo.replace(/\s/g, '')}" class="accordion-collapse collapse" 
                     data-bs-parent="#vehiculoAccordion"
                     style="padding: 6px 10px; font-size: 16px; min-height: 35px; line-height: 1;">
                    <div class="accordion-body" style="padding: 0px; margin: 0px;">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center">
                                <thead style="background-color: #0a6ad1; color: white;">
                                    <tr>
                                        <th style="width: 10%;">Posici√≥n</th>
                                        <th style="width: 25%;">Componente</th>
                                        <th style="width: 10%;">Estado</th>
                                        <th style="width: 55%;">Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-${grupo.replace(/\s/g, '')}">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
    
            acordeon.appendChild(seccionHTML);
            const tbody = document.getElementById(`tbody-${grupo.replace(/\s/g, '')}`);
    
            // Recorrer cada posici√≥n y agregar correctamente las filas con celdas combinadas
            Object.keys(posicionesAgrupadas).forEach(posicion => {
                const componentesList = posicionesAgrupadas[posicion];
                const totalComponentes = componentesList.length;
    
                componentesList.forEach((item, index) => {
                    let fila = document.createElement("tr");
    
                    // Solo agregar la celda de "Posici√≥n" en la primera fila del grupo
                    if (index === 0) {
                        let celdaPosicion = document.createElement("td");
                        celdaPosicion.rowSpan = totalComponentes;  // Combina las filas
                        celdaPosicion.textContent = posicion;
                        celdaPosicion.classList.add("fw-bold", "text-center", "align-middle", "bg-light");
                        fila.appendChild(celdaPosicion);
                    }
    
                    // Celda de Componente
                    let celdaComponente = document.createElement("td");
                    celdaComponente.textContent = item.componente;
                    fila.appendChild(celdaComponente);
    
                    // Generar un nombre √∫nico para los radios (cada componente tiene su propio grupo)
                    let radioName = `comp_estado_${item.id_componente}`;
    
                    // Celda de Estado (radio buttons)
                    let celdaEstado = document.createElement("td");
                    celdaEstado.innerHTML = `
                        <div class="d-flex align-items-center justify-content-center gap-0">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="${radioName}" value="OK"
                                    style="transform: scale(1.5); margin-right: 0px;">
                                <label class="form-check-label fw-bold">OK</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="${radioName}" value="Falla"
                                    style="transform: scale(1.5); margin-right: 0px;">
                                <label class="form-check-label fw-bold">Falla</label>
                            </div>
                        </div>
                    `;

                    fila.appendChild(celdaEstado);
    
                    // Celda de Observaciones
                    let celdaObservacion = document.createElement("td");
                    celdaObservacion.innerHTML = `<input type="text" class="form-control">`;
                    fila.appendChild(celdaObservacion);
    
                    // Guardar el ID del componente en la fila
                    fila.setAttribute("data-idComponente", item.id_componente);
    
                    tbody.appendChild(fila);
                });
            });
        });

        activarCambioColorEstado();
    
        agregarBotonesFinales();
    }                 
    
    // Funci√≥n para incluir colorimetria al cambiar estado de los radio buttons y notificar si se intenta cambiar de Falla a OK
    function activarCambioColorEstado() {
        document.querySelectorAll("input[type='radio']").forEach(radio => {
            const originalEstado = radio.dataset.originalEstado;
    
            // Si es el radio "OK" y el estado original era "Falla", lo deshabilitamos
            if (radio.value === "OK" && originalEstado === "Falla") {
                radio.disabled = true;
            }
    
            // Color visual del estado
            radio.addEventListener("change", function () {
                const celda = this.closest("td");
                if (this.value === "OK") {
                    celda.style.backgroundColor = "#c8e6c9";
                } else if (this.value === "Falla") {
                    celda.style.backgroundColor = "#ffcccb";
                }
            });
    
            // Aplicar color de entrada si ya est√° seleccionado
            if (radio.checked) {
                radio.dispatchEvent(new Event("change"));
            }
        });
    }    

    // Funci√≥n para agregar los botones finales al final del acorde√≥n
    function agregarBotonesFinales() {
        let botonesFinales = document.getElementById("botonesFinales");
    
        if (botonesFinales) {
            botonesFinales.remove();
        }
    
        botonesFinales = document.createElement("div");
        botonesFinales.id = "botonesFinales";
        botonesFinales.classList.add("d-flex", "justify-content-end", "mt-3");
    
        botonesFinales.innerHTML = `
            <button class="btn btn-secondary me-2" onclick="limpiarConsulta()">Limpiar</button>
            <button class="btn btn-success" id="btnGuardar" onclick="guardarChecklist()">Guardar</button>
        `;
    
        document.getElementById("vehiculoAccordion").appendChild(botonesFinales);
    }    

</script>

<!--  JavaScript para Guardar todo el CheckList  -->
<script>
    async function guardarChecklist() {
        const btnGuardar = document.querySelector("#btnGuardar");

        if (!btnGuardar) {
            console.error("‚ùå Error: No se encontr√≥ el bot√≥n de guardar.");
            return;
        }

        // Evitar m√∫ltiples clics deshabilitando el bot√≥n
        btnGuardar.disabled = true;

        const idVehiculo = document.getElementById("searchPlaca").getAttribute("data-idVehiculo");
        if (!idVehiculo) {
            alert("Debe seleccionar un veh√≠culo v√°lido antes de guardar.");
            btnGuardar.disabled = false; // Habilitar el bot√≥n nuevamente
            return;
        }
    
        const fechaHoraRegistro = document.getElementById("fechaHoraRegistro").value;
        const inicioTurno = document.getElementById("inicioTurno").value;
        const finTurno = document.getElementById("finTurno").value;
        const kmOdometro = document.getElementById("kmOdometro").value;
        const observacionesGenerales = document.getElementById("observacionGeneral").value;
        const usuarioRegistra = "{{ user_session.nombres }} {{ user_session.apellidos }}";
    
        // Validar que los campos obligatorios est√©n completos
        if (!fechaHoraRegistro || !inicioTurno || !finTurno || !kmOdometro) {
            alert("‚ö†Ô∏è Todos los campos obligatorios deben ser diligenciados.");
            btnGuardar.disabled = false; // Habilitar el bot√≥n nuevamente
            return;
        }
    
        let documentos = [];
        let faltaDocumento = false;

        document.querySelectorAll("#tbody-documentos tr").forEach(row => {
            const idTipoDocumento = row.getAttribute("data-idTipoDocumento");
            const estadoSeleccionado = row.querySelector("input[name^='doc_estado_']:checked");

            /*
            console.log("üîç Documento detectado:", {
                idTipoDocumento,
                estado: estadoSeleccionado ? estadoSeleccionado.value : "No seleccionado"
            });
            */

            if (!estadoSeleccionado) faltaDocumento = true;

            documentos.push({
                id_tipo_documento: idTipoDocumento ? parseInt(idTipoDocumento, 10) : null,
                estado: estadoSeleccionado ? (estadoSeleccionado.value === "OK" ? 1 : 0) : null,
                observaciones: row.querySelector("input[type='text']").value || ""
            });
        });

        if (faltaDocumento) {
            alert("‚ö†Ô∏è Debe seleccionar el estado de todos los documentos.");
            btnGuardar.disabled = false;
            return;
        }
    
        let detalles = [];
        let faltaDetalle = false;
    
        document.querySelectorAll("#vehiculoAccordion tbody tr").forEach(row => {
            const estado = row.querySelector("input[name^='comp_estado_']:checked")?.value;
            const idComponente = row.getAttribute("data-idComponente"); 
        
            // Evitar agregar registros sin ID v√°lido
            if (!idComponente) return;
        
            if (!estado) faltaDetalle = true;
        
            detalles.push({
                id_componente: idComponente,  
                estado: estado === "OK" ? 1 : 0,
                observaciones: row.querySelector("input[type='text']").value || ""
            });
        
            //console.log("üîç Componente detectado:", { idComponente, estado });
        });                        
    
        if (faltaDetalle) {
            alert("‚ö†Ô∏è Debe seleccionar el estado de todos los componentes del veh√≠culo.");
            btnGuardar.disabled = false;
            return;
        }
    
        if (documentos.length === 0 || detalles.length === 0) {
            alert("‚ö†Ô∏è Debe completar la verificaci√≥n de documentos y el estado del veh√≠culo.");
            btnGuardar.disabled = false;
            return;
        }
    
        const payload = {
            registro: {
                id_vehiculo: idVehiculo,
                fecha_hora_registro: fechaHoraRegistro,
                inicio_turno: inicioTurno,
                fin_turno: finTurno,
                km_odometro: kmOdometro,
                observaciones_generales: observacionesGenerales,
                usuario_registro: usuarioRegistra
            },
            documentos: documentos,
            detalles: detalles
        };
    
        //console.log("üì¶ Payload enviado:", JSON.stringify(payload, null, 2));
        
        // Mostrar GIF procesando mientras termina la petici√≥n
        document.getElementById("loadingOverlay").style.display = "block";
    
        try {
            const response = await fetch("/guardar_checklist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
    
            const data = await response.json();

            // Ocultar GIF de carga
            document.getElementById("loadingOverlay").style.display = "none";

            if (response.ok) {
                alert("‚úÖ Checklist guardado correctamente con ID: " + data.id_checklist);
                limpiarFormularioChecklist();
                location.reload();
            } else {
                alert("‚ö†Ô∏è Error al guardar: " + (data.detail || "Error desconocido."));
                btnGuardar.disabled = false;
            }
        } catch (error) {
            document.getElementById("loadingOverlay").style.display = "none"; // Ocultar GIF de carga
            console.error("‚ùå Error al guardar checklist:", error);
            alert("Ocurri√≥ un error al guardar el checklist.");
            btnGuardar.disabled = false;
        }
    }  
    
    // Limpia todos los campos del formulario tras el guardado
    function limpiarFormularioChecklist() {
        document.getElementById("searchPlaca").value = "";
        document.getElementById("fechaHoraRegistro").value = "";
        document.getElementById("inicioTurno").value = "";
        document.getElementById("finTurno").value = "";
        document.getElementById("kmOdometro").value = "";
        document.getElementById("observacionGeneral").value = "";

        // Limpiar selecci√≥n de radio buttons y campos de texto en Documentos
        document.querySelectorAll("#tbody-documentos input[type='radio']").forEach(radio => {
            radio.checked = false;
        });
        document.querySelectorAll("#tbody-documentos input[type='text']").forEach(input => {
            input.value = "";
        });

        // Limpiar selecci√≥n de radio buttons y campos de texto en Componentes
        document.querySelectorAll("#vehiculoAccordion tbody input[type='radio']").forEach(radio => {
            radio.checked = false;
        });
        document.querySelectorAll("#vehiculoAccordion tbody input[type='text']").forEach(input => {
            input.value = "";
        });

        // Restablecer la colorimetr√≠a de todas las celdas de estado en Documentos
        document.querySelectorAll("#tbody-documentos td").forEach(celda => {
            celda.style.backgroundColor = "transparent"; // Restaura el color a su estado original
        });

        // Restablecer la colorimetr√≠a de todas las celdas de estado en Componentes
        document.querySelectorAll("#vehiculoAccordion tbody td").forEach(celda => {
            celda.style.backgroundColor = "transparent"; // Restaura el color a su estado original
        });
    }
</script>

<!--  JavaScript para Manejo de Veh√≠culos  -->
<script>
    window.onload = cargarVehiculos;
    // Cargar veh√≠culos cuando se carga la p√°gina
    async function cargarVehiculos() {
        const response = await fetch("/vehiculos");
        const vehiculos = await response.json();
        const tbody = document.getElementById("vehiculosTable");
        tbody.innerHTML = "";
    
        vehiculos.forEach(vehiculo => {
            // Determinar si el veh√≠culo est√° activo o inactivo
            const estadoTexto = vehiculo.estado === 1 ? "Activo" : "Inactivo";
            const estadoClase = vehiculo.estado === 1 ? "text-success" : "text-danger";
    
            // Crear bot√≥n de editar
            const botonEditar = `
            <button class="btn btn-sm btn-primary" 
                style="height: 30px; padding: 4px 6px; font-size: 14px;" 
                onclick="editarVehiculo('${vehiculo.placa}')"
                data-bs-toggle="modal" data-bs-target="#editVehicleModal">
                <i class="fas fa-edit"></i> Editar
            </button>`;

            // Crear bot√≥n de inactivar/activar
            const botonEstado = vehiculo.estado === 1
            ? `<button class="btn btn-sm btn-warning" 
                style="height: 30px; width: 70px; padding: 4px 6px; font-size: 14px;" 
                onclick="cambiarEstadoVehiculo('${vehiculo.placa}', 0)">
                <i class="fas fa-ban"></i> Inactivar
            </button>`
            : `<button class="btn btn-sm btn-success" 
                style="height: 30px; width: 70px; padding: 4px 6px; font-size: 14px;" 
                onclick="cambiarEstadoVehiculo('${vehiculo.placa}', 1)">
                <i class="fas fa-check"></i> Activar
            </button>`;
    
            // Agregar la fila a la tabla
            const row = `<tr>
                <td>${vehiculo.placa}</td>
                <td>${vehiculo.tipo_vehiculo_nombre}</td>
                <td>${vehiculo.marca}</td>
                <td>${vehiculo.linea}</td>
                <td>${vehiculo.modelo}</td>
                <td class="${estadoClase}">${estadoTexto}</td>
                <td>
                    ${botonEditar}
                    ${botonEstado}
                </td>
            </tr>`;
    
            tbody.innerHTML += row;
        });
    }      
    
    // Cargar tipos de veh√≠culos en las listas desplegables
    async function cargarTiposVehiculos() {
        try {
            const response = await fetch("/tipos_vehiculos");
            if (!response.ok) {
                throw new Error("No se pudo obtener la lista de tipos de veh√≠culos");
            }

            const tipos = await response.json();
            const selectTipoVehiculo = document.getElementById("tipoVehiculo");
            const selectEditTipoVehiculo = document.getElementById("editTipoVehiculo");

            // Limpiar listas y agregar opci√≥n por defecto
            selectTipoVehiculo.innerHTML = '<option disabled selected>Seleccione el tipo...</option>';
            selectEditTipoVehiculo.innerHTML = '<option disabled selected>Seleccione el tipo...</option>';

            // Poblar las listas con los valores desde la base de datos
            tipos.forEach(tipo => {
                let option = `<option value="${tipo.id_tipo_vehiculo}">${tipo.nombre}</option>`;
                selectTipoVehiculo.innerHTML += option;
                selectEditTipoVehiculo.innerHTML += option;
            });
        } catch (error) {
            console.error("Error al cargar tipos de veh√≠culos:", error);
        }
    }

    // Enviar formulario y crear un nuevo veh√≠culo
    document.getElementById("createVehicleForm").addEventListener("submit", async function(event) {
        event.preventDefault();
        
        const data = {
            placa: document.getElementById("placaVehiculo").value.toUpperCase(),
            id_tipo_vehiculo: document.getElementById("tipoVehiculo").value,
            marca: document.getElementById("marcaVehiculo").value,
            linea: document.getElementById("lineaVehiculo").value,
            modelo: document.getElementById("modeloVehiculo").value
        };
    
        const response = await fetch("/vehiculos/crear", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
    
        const result = await response.json();
        if (result.message) {
            alert(result.message);
            cargarVehiculos(); // Recargar la tabla

            // Limpiar formulario despu√©s de la creaci√≥n
            document.getElementById("createVehicleForm").reset();
        } else {
            alert("Error al crear veh√≠culo: " + result.error);
        }
    });

    // Carga de Veh√≠culos y Tipos al Abrir la Pesta√±a
    document.addEventListener("DOMContentLoaded", function () {
        const vehiculosTab = document.getElementById("vehiculos-tab"); // Ajustar seg√∫n ID de la pesta√±a
        if (vehiculosTab) {
            vehiculosTab.addEventListener("shown.bs.tab", function () {
                cargarTiposVehiculos(); // Cargar la lista de tipos de veh√≠culos
                cargarVehiculos(); // Cargar la lista de veh√≠culos registrados
            });
        }
    });    

    // Edita configuraci√≥n del veh√≠culos en ventana modal
    async function editarVehiculo(placa) {
        try {
            const response = await fetch(`/vehiculos/${placa}`);
            if (!response.ok) {
                throw new Error("No se pudo obtener el veh√≠culo");
            }
            const vehiculo = await response.json();

            // Llenar los campos del modal con los datos del veh√≠culo
            document.getElementById("editVehicleIdHidden").value = vehiculo.placa;
            document.getElementById("editPlacaVehiculo").value = vehiculo.placa;
            document.getElementById("editTipoVehiculo").value = vehiculo.id_tipo_vehiculo;  // ID correcto
            document.getElementById("editMarcaVehiculo").value = vehiculo.marca;
            document.getElementById("editLineaVehiculo").value = vehiculo.linea;
            document.getElementById("editModeloVehiculo").value = vehiculo.modelo;

            // El veh√≠culo seleccionado coincida con el del veh√≠culo
            const selectTipo = document.getElementById("editTipoVehiculo");
            for (let i = 0; i < selectTipo.options.length; i++) {
                if (selectTipo.options[i].value == vehiculo.id_tipo_vehiculo) {
                    selectTipo.selectedIndex = i;
                    break;
                }
            }
        } catch (error) {
            alert("Error al obtener datos del veh√≠culo: " + error.message);
        }
    }    
    
    // Permite cambiar el estado activo o inactivo de un vehiculo
    async function cambiarEstadoVehiculo(placa, nuevoEstado) {
        const confirmacion = nuevoEstado === 0 
            ? confirm("¬øEst√°s seguro de que deseas INACTIVAR este veh√≠culo?")
            : confirm("¬øDeseas ACTIVAR este veh√≠culo?");
        
        if (!confirmacion) return;
    
        const response = await fetch(`/vehiculos/inactivar/${placa}/${nuevoEstado}`, { method: "PUT" });
        const result = await response.json();
    
        if (result.message) {
            alert(result.message);
            cargarVehiculos(); // Recargar la tabla con los cambios
        } else {
            alert("Error al cambiar el estado del veh√≠culo: " + result.error);
        }
    }     
    
    // Guardar Cambios de un vehiculo
    document.getElementById("editVehicleForm").addEventListener("submit", async function(event) {
        event.preventDefault();
    
        const placa = document.getElementById("editPlacaVehiculo").value;
        const data = {
            id_tipo_vehiculo: document.getElementById("editTipoVehiculo").value,
            marca: document.getElementById("editMarcaVehiculo").value,
            linea: document.getElementById("editLineaVehiculo").value,
            modelo: document.getElementById("editModeloVehiculo").value
        };
    
        const response = await fetch(`/vehiculos/actualizar/${placa}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });
    
        const result = await response.json();
        if (result.message) {
            alert(result.message);
            cargarVehiculos(); // Recargar la tabla
            document.getElementById("editVehicleModal").classList.remove("show"); // Cerrar modal visualmente
            document.querySelector(".modal-backdrop").remove(); // Eliminar fondo del modal
            document.getElementById("editVehicleModal").style.display = "none"; // Ocultar el modal
        } else {
            alert("Error al actualizar veh√≠culo: " + result.error);
        }
    });    

</script>

<!--  JavaScript para consolidar fallas y gesti√≥n del CheckList  -->
<script>
    async function cargarFallas() {
        try {
            const response = await fetch('/fallas_vehiculos');
            const data = await response.json();
            const tbody = document.querySelector("#tablaFallas tbody");
            tbody.innerHTML = "";
    
            // Filtros
            const placaFiltro = document.getElementById("buscarPlaca").value.toUpperCase();
            const tipoFiltro = document.getElementById("buscarTipoVehiculo").value.toUpperCase();
            const marcaFiltro = document.getElementById("buscarMarca").value.toUpperCase();
            const lineaFiltro = document.getElementById("buscarLinea").value.toUpperCase();
            const modeloFiltro = document.getElementById("buscarModelo").value.toUpperCase();
    
            // Aplicar filtros a cada fila
            const filtrados = data.filter(item => {
                return (
                    (!placaFiltro || item.placa.toUpperCase().includes(placaFiltro)) &&
                    (!tipoFiltro || item.tipo_vehiculo.toUpperCase().includes(tipoFiltro)) &&
                    (!marcaFiltro || item.marca.toUpperCase().includes(marcaFiltro)) &&
                    (!lineaFiltro || item.linea.toUpperCase().includes(lineaFiltro)) &&
                    (!modeloFiltro || String(item.modelo).includes(modeloFiltro))
                );
            });
    
            // Mostrar mensaje si no hay resultados
            if (filtrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7">No se encontraron resultados.</td></tr>`;
                return;
            }
    
            // Generar tabla
            filtrados.forEach(item => {
                const fila = document.createElement("tr");
                // Si tiene fallas, agregar clase de color rojo claro
                if (item.estado === "Fallas") {
                    fila.classList.add("table-danger");
                }
            
                fila.innerHTML = `
                    <td>
                        <button type="button"
                        class="btn btn-light border d-flex align-items-center justify-content-center"
                        style="padding: 5px; height: 30px; width: 30px; border-color: rgb(13, 15, 124);"
                        onclick="abrirModalFalla('${item.placa}')"
                        data-bs-toggle="modal"
                        data-bs-target="#modalFalla"
                        title="Gestionar Falla">
                        <img src="/static/images/editar.png" alt="Editar" style="width: 35px; height: 35px;">
                    </button>
                    </td>
                    <td>${item.placa}</td>
                    <td>${item.tipo_vehiculo}</td>
                    <td>${item.marca}</td>
                    <td>${item.linea}</td>
                    <td>${item.modelo}</td>
                    <td class="fw-bold ${item.estado === 'Fallas' ? 'text-danger' : 'text-success'}">
                        ${item.estado === 'Fallas' ? '‚ö†Ô∏è Fallas' : '‚úÖ Correcto'}
                    </td>
                    <td class="fw-bold ${item.vinculacion === 'Activo' ? 'text-success' : 'text-danger'}">
                        ${item.vinculacion === 'Activo' ? 'üü¢ Activo' : 'üö´ Inactivo'}
                    </td>
                `;
                tbody.appendChild(fila);
            });
        } catch (error) {
            console.error("‚ùå Error al cargar fallas:", error);
            alert("Ocurri√≥ un error al cargar los datos.");
        }
    }    
    
    async function abrirModalFalla(placa) {
        try {
            const response = await fetch(`/fallas_vehiculo/${placa}`);
            if (!response.ok) throw new Error(`Error ${response.status}`);
    
            data = await response.json();
            if (data.error) {
                alert(data.error);
                return;
            }

            // Rellenar km del √∫ltimo checklist
            const kmInput = document.getElementById("kmOdometro");
            if (kmInput && data.checklist?.km_odometro) {
                kmInput.value = data.checklist.km_odometro;
            }
    
            // Encabezado
            document.getElementById("fallaPlaca").textContent = data.vehiculo.placa;
            document.getElementById("fallaTipoVehiculo").textContent = data.vehiculo.tipo_vehiculo;
            document.getElementById("fallaMarca").textContent = data.vehiculo.marca;
            document.getElementById("fallaLinea").textContent = data.vehiculo.linea;
            document.getElementById("fallaModelo").textContent = data.vehiculo.modelo;
    
            // Observaciones generales
            document.getElementById("tablaObservacionesGenerales").innerHTML = data.observaciones_generales.map(row => `
                <tr>
                    <td>${row.fecha_hora_registro}</td>
                    <td>${row.observaciones_generales}</td>
                    <td>${row.usuario_registro}</td>
                </tr>
            `).join("");
    
            // Documentos
            const tbodyDocs = document.getElementById("tablaFallasDocumentos");
            tbodyDocs.innerHTML = "";

            data.fallas_documentos.forEach(doc => {
                const entry = doc.historial[0]; // Solo el m√°s reciente
                if (!entry) return;

                const filaClass = doc.estado_actual ? "" : "table-danger";

                tbodyDocs.innerHTML += `
                    <tr class="${filaClass}">
                        <td class="text-center align-middle">
                            <button onclick="verHistorialDocumento(${doc.id_tipo_documento})" style="border: none; background: none; padding: 0;">
                                <img src="/static/images/editar.png" alt="Historial" style="width: 25px; height: 25px; cursor: pointer;">
                            </button>
                        </td>
                        <td>${entry.fecha}</td>
                        <td>${doc.tipo_documento}</td>
                        <td>${entry.observacion}</td>
                        <td>${entry.usuario}</td>
                        <td>${doc.estado_actual ? '‚úîÔ∏è OK' : '‚ùå Falla'}</td>
                        <td class="text-center align-middle">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input ajuste-switch ${doc.estado_actual ? '' : 'switch-falla'}"
                                    type="checkbox"
                                    data-id="${doc.id_tipo_documento}" data-tipo="documento"
                                    ${doc.estado_actual ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm observacion-ajuste"
                                data-id="${doc.id_tipo_documento}" data-tipo="documento">
                        </td>
                    </tr>
                `;
            });

            // Componentes
            const tbodyComp = document.getElementById("tablaFallasComponentes");
            tbodyComp.innerHTML = "";

            data.fallas_componentes.forEach(comp => {
                const entry = comp.historial[0]; // Solo el m√°s reciente
                if (!entry) return;

                const filaClass = comp.estado_actual ? "" : "table-danger";

                tbodyComp.innerHTML += `
                    <tr class="${filaClass}">
                        <td class="text-center align-middle">
                            <button onclick="verHistorialComponente(${comp.id_componente})" style="border: none; background: none; padding: 0;">
                                <img src="/static/images/editar.png" alt="Historial" style="width: 25px; height: 25px; cursor: pointer;">
                            </button>
                        </td>
                        <td>${entry.fecha}</td>
                        <td>${comp.grupo}</td>
                        <td>${comp.posicion}</td>
                        <td>${comp.componente}</td>
                        <td>${entry.observacion}</td>
                        <td>${entry.usuario}</td>
                        <td>${comp.estado_actual ? '‚úîÔ∏è OK' : '‚ùå Falla'}</td>
                        <td class="text-center align-middle">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input ajuste-switch ${comp.estado_actual ? '' : 'switch-falla'}"
                                    type="checkbox"
                                    data-id="${comp.id_componente}" data-tipo="componente"
                                    ${comp.estado_actual ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm observacion-ajuste"
                                data-id="${comp.id_componente}" data-tipo="componente">
                        </td>
                    </tr>
                `;
            });

            // Activar estilos para switches
            document.querySelectorAll(".ajuste-switch").forEach(input => {
                if (!input.checked) {
                    input.classList.add("switch-falla");
                } else {
                    input.classList.remove("switch-falla");
                }
                input.addEventListener("change", function () {
                    if (this.checked) {
                        this.classList.remove("switch-falla");
                    } else {
                        this.classList.add("switch-falla");
                    }
                });
            });

            // Activar validaci√≥n de cambios en ajustes
            activarEscuchaCambiosAjustes();
    
            new bootstrap.Modal(document.getElementById("modalFalla")).show();
        } catch (error) {
            console.error("‚ùå Error al abrir modal de falla:", error);
            alert("Ocurri√≥ un error al consultar los detalles del veh√≠culo.");
        }
    }
    
    function cerrarModalFalla() {
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalFalla"));
        if (modal) {
            modal.hide();
        }
        document.body.classList.remove("modal-open");
        document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
    }    

    // Cargar autom√°ticamente si est√° visible
    document.addEventListener("DOMContentLoaded", function () {
        const tab = document.getElementById("fallas-tab");
        if (tab) {
            tab.addEventListener("shown.bs.tab", function () {
                cargarFallas();
            });
        }
    
        if (window.location.hash === "#fallas") {
            cargarFallas();
        }
    
        // Filtros din√°micos
        ["buscarPlaca", "buscarTipoVehiculo", "buscarMarca", "buscarLinea", "buscarModelo"].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener("input", () => {
                    cargarFallas();  // recargar al escribir
                });
            }
        });
    });
    
    // Autocompletar placa en pesta√±a de Fallas
    document.getElementById("buscarPlaca").addEventListener("input", async function () {
        const query = this.value.trim();
        const placaList = document.getElementById("placaList"); // usa el mismo dropdown de sugerencias

        if (query.length < 1) {
            placaList.innerHTML = "";
            return;
        }

        try {
            const response = await fetch(`/vehiculos/buscar/${query}`);
            const placas = await response.json();

            placaList.innerHTML = "";

            if (placas.length === 0) {
                placaList.innerHTML = `<button class="list-group-item list-group-item-action disabled">No hay coincidencias</button>`;
                return;
            }

            placas.forEach(vehiculo => {
                const item = document.createElement("button");
                item.classList.add("list-group-item", "list-group-item-action");
                item.style.padding = "4px";
                item.style.fontSize = "14px";
                item.textContent = vehiculo.placa;

                item.addEventListener("click", function () {
                    document.getElementById("buscarPlaca").value = vehiculo.placa.toUpperCase();
                    placaList.innerHTML = "";
                    // Opcional: autoejecutar b√∫squeda si se quiere al seleccionar
                    // cargarFallas();
                });

                placaList.appendChild(item);
            });
        } catch (error) {
            console.error("Error en autocompletar placa (fallas):", error);
        }
    });

    // Limpiar filtros de b√∫squeda
    function limpiarFiltros() {
        document.getElementById("buscarPlaca").value = "";
        document.getElementById("buscarTipoVehiculo").value = "";
        document.getElementById("buscarMarca").value = "";
        document.getElementById("buscarLinea").value = "";
        document.getElementById("buscarModelo").value = "";
        cargarFallas();
    }
    
    // Documentos: historial completo
    function verHistorialDocumento(id) {
        const doc = data.fallas_documentos.find(d => d.id_tipo_documento === id);
        if (!doc) return;

        // Cambiar t√≠tulo
        document.getElementById("modalHistorialLabel").textContent = `Historial - ${doc.tipo_documento}`;

        // Encabezados
        document.getElementById("historialHeader").innerHTML = `
            <tr>
                <th>Fecha Reporte</th>
                <th>Tipo</th>
                <th>Observaci√≥n</th>
                <th>Registrado Por</th>
                <th>Estado</th>
            </tr>
        `;

        // Cuerpo
        document.getElementById("tablaHistorialBody").innerHTML = doc.historial.map(h => `
            <tr>
                <td>${h.fecha}</td>
                <td>${doc.tipo_documento}</td>
                <td>${h.observacion}</td>
                <td>${h.usuario}</td>
                <td>${h.estado ? '‚úîÔ∏è OK' : '‚ùå Falla'}</td>
            </tr>
        `).join("");

        new bootstrap.Modal(document.getElementById("modalHistorial")).show();
    }

    // Componentes: historial completo
    function verHistorialComponente(id) {
        const comp = data.fallas_componentes.find(c => c.id_componente === id);
        if (!comp) return;

        document.getElementById("modalHistorialLabel").textContent = `Historial - ${comp.componente}`;

        document.getElementById("historialHeader").innerHTML = `
            <tr>
                <th>Fecha Reporte</th>
                <th>Grupo</th>
                <th>Posici√≥n</th>
                <th>Componente</th>
                <th>Observaci√≥n</th>
                <th>Registrado Por</th>
                <th>Estado</th>
            </tr>
        `;

        document.getElementById("tablaHistorialBody").innerHTML = comp.historial.map(h => `
            <tr>
                <td>${h.fecha}</td>
                <td>${comp.grupo}</td>
                <td>${comp.posicion}</td>
                <td>${comp.componente}</td>
                <td>${h.observacion}</td>
                <td>${h.usuario}</td>
                <td>${h.estado ? '‚úîÔ∏è OK' : '‚ùå Falla'}</td>
            </tr>
        `).join("");

        new bootstrap.Modal(document.getElementById("modalHistorial")).show();
    }
    
    // Activar boton de guardar cuando exista cambios en ajustes de fallas
    function activarEscuchaCambiosAjustes() {
        const btnGuardar = document.getElementById("btnGuardarCambiosChecklist");
        btnGuardar.disabled = true;
    
        const inputs = document.querySelectorAll(".ajuste-switch, .observacion-ajuste");
        inputs.forEach(input => {
            input.addEventListener("change", verificarCambiosEnAjustes);
            input.addEventListener("input", verificarCambiosEnAjustes);
        });
    }
    
    function verificarCambiosEnAjustes() {
        const btnGuardar = document.getElementById("btnGuardarCambiosChecklist");
        let cambio = false;
    
        document.querySelectorAll(".ajuste-switch").forEach(switchEl => {
            const original = !switchEl.classList.contains("switch-falla");
            if (switchEl.checked !== original) cambio = true;
        });
    
        document.querySelectorAll(".observacion-ajuste").forEach(input => {
            if (input.value.trim() !== "") cambio = true;
        });
    
        btnGuardar.disabled = !cambio;
    }    

    function obtenerFechaHoraBogota() {
        const fechaUTC = new Date();
        const opcionesFecha = { timeZone: "America/Bogota", year: "numeric", month: "2-digit", day: "2-digit" };
        const opcionesHora = { timeZone: "America/Bogota", hour: "2-digit", minute: "2-digit", hour12: false };
    
        const fechaBogota = new Intl.DateTimeFormat("es-CO", opcionesFecha).format(fechaUTC);
        const horaBogota = new Intl.DateTimeFormat("es-CO", opcionesHora).format(fechaUTC);
    
        const [dia, mes, anio] = fechaBogota.split("/");
        const fechaFormateada = `${anio}-${mes}-${dia}`;
        const horaFormateada = horaBogota.replace(":", ":");
    
        return `${fechaFormateada} ${horaFormateada}:00`;
    }    

    // Guardar cambios en el checklist
    document.getElementById("btnGuardarCambiosChecklist").addEventListener("click", async function () {
        const idVehiculo = data.vehiculo.id;
        const kmOdometro = parseInt(document.getElementById("kmOdometro").value || "0", 10);
        const usuarioRegistra = "{{ user_session.nombres }} {{ user_session.apellidos }}";
    
        const ahora = new Date();
        const fechaHora = obtenerFechaHoraBogota();
    
        let documentos = [];
        let detalles = [];
        let cambiosDetectados = false;
    
        // Documentos
        document.querySelectorAll("#tablaFallasDocumentos tr").forEach(row => {
            const switchEl = row.querySelector("input[type='checkbox']");
            const observacion = row.querySelector(".observacion-ajuste")?.value?.trim() || "";
            const id = parseInt(switchEl.dataset.id);
            const original = !switchEl.classList.contains("switch-falla");
            const estadoActual = switchEl.checked;
    
            if (estadoActual !== original || observacion !== "") cambiosDetectados = true;
    
            documentos.push({
                id_tipo_documento: id,
                estado: estadoActual,
                observaciones: observacion
            });
        });
    
        // Componentes
        document.querySelectorAll("#tablaFallasComponentes tr").forEach(row => {
            const switchEl = row.querySelector("input[type='checkbox']");
            const observacion = row.querySelector(".observacion-ajuste")?.value?.trim() || "";
            const id = parseInt(switchEl.dataset.id);
            const original = !switchEl.classList.contains("switch-falla");
            const estadoActual = switchEl.checked;
    
            if (estadoActual !== original || observacion !== "") cambiosDetectados = true;
    
            detalles.push({
                id_componente: id,
                estado: estadoActual,
                observaciones: observacion
            });
        });
    
        if (!cambiosDetectados) {
            alert("No se han detectado cambios para guardar.");
            return;
        }
    
        const payload = {
            registro: {
                id_vehiculo: idVehiculo,
                fecha_hora_registro: fechaHora,
                inicio_turno: "07:00",
                fin_turno: "17:00",
                km_odometro: kmOdometro,
                observaciones_generales: "",
                usuario_registro: usuarioRegistra
            },
            documentos: documentos,
            detalles: detalles
        };
    
        try {
            document.getElementById("loadingOverlay").style.display = "block";
            const res = await fetch("/guardar_checklist", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
    
            const resultado = await res.json();
            document.getElementById("loadingOverlay").style.display = "none";
    
            if (res.ok) {
                alert("‚úÖ Cambios guardados exitosamente como nuevo checklist.");
                cerrarModalFalla();
                location.reload();
            } else {
                console.error("‚ùå Error al guardar:", resultado);
                alert("‚ùå Error al guardar: " + (resultado.detail || "Error desconocido"));
            }
        } catch (err) {
            document.getElementById("loadingOverlay").style.display = "none";
            console.error(err);
            alert("‚ùå Ocurri√≥ un error al intentar guardar el checklist.");
        }
    });
    
</script>

<!-- Estilos personalizados para la tabla fallas-->
<style>
    #tablaFallas tbody td input,
    #tablaFallas tbody td button,
    #tablaFallas tbody td img {
        height: 24px !important;
        padding: 2px 6px !important;
        font-size: 13px !important;
    }

    #tablaFallas tbody td {
        padding-top: 2px !important;
        padding-bottom: 2px !important;
        vertical-align: middle !important;
    }

    .modal-backdrop.show {
        opacity: 0.6 !important; 
        z-index: 1040; /* menor que el modal interno */
    }  
    
    /* CONFIGURACI√ìN TOGGEL SWITCH */
    /* FONDO y BORDE cuando est√° en Falla (apagado, sin check) */
    .ajuste-switch.switch-falla {
        background-color: #f44336 !important; /* Rojo */
        border-color: #f44336 !important;
    }

    .ajuste-switch.switch-falla:focus {
        box-shadow: 0 0 0 0.1rem #f4433644 !important;
    }

    /* FONDO y BORDE cuando est√° en OK (encendido, con check) */
    .ajuste-switch:checked {
        background-color: #28a745 !important; /* Verde */
        border-color: #28a745 !important;
    }

    .ajuste-switch:checked:focus {
        box-shadow: 0 0 0 0.1rem #28a74544 !important;
    }

    /* Siempre que sea .ajuste-switch (OK o Falla), c√≠rculo blanco */
    .ajuste-switch::before {
        background-color: white !important;
        box-shadow: none !important;
        border: none !important;
    }

    /* Reforzar si est√° en Falla y apagado */
    .ajuste-switch.switch-falla:not(:checked)::before {
        background-color: white !important;
    }

    /* Reforzar si est√° en OK y encendido */
    .ajuste-switch:checked::before {
        background-color: white !important;
    }

    /* Transici√≥n suave al mover el switch */
    .ajuste-switch {
        transition: background-color 0.3s ease-in-out;
    }

     /* Ajuste de tama√±o del switch */
    .ajuste-switch {
        width: 35px;     /* ancho del switch */
        height: 20px;    /* alto del switch */
    }

    /* Ajuste del "c√≠rculo blanco" interior del switch */
    .ajuste-switch::before {
        width: 20px;     /* ancho del c√≠rculo */
        height: 20px;    /* alto del c√≠rculo */
        top: 2px;        /* alineaci√≥n vertical */
        left: 2px;       /* alineaci√≥n horizontal cuando est√° apagado */
    }

    .ajuste-switch:checked::before {
        transform: translateX(25px);  /* distancia que se mueve el c√≠rculo al activarse */
    }

    .encabezado-reporte {
        background-color: #001F54; /* encabezado pesta√±a consulta de reportes */
        color: white;
        font-weight: bold;
        text-align: center;
    }

</style>

<!--  JavaScript para la consulta de reportes de checklist  -->
<script>
    // Cargar los filtros al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const res = await fetch("/reportes/filtros");
            const data = await res.json();
    
            llenarSelect("filtroPlaca", data.placas);
            llenarSelect("filtroTipoVehiculo", data.tipos);
            llenarSelect("filtroMarca", data.marcas);
            llenarSelect("filtroUsuario", data.usuarios);
        } catch (err) {
            console.error("Error al cargar filtros:", err);
        }
    });
    
    function llenarSelect(id, valores) {
        const select = document.getElementById(id);
        valores.forEach(v => {
            const option = document.createElement("option");
            option.value = v;
            option.text = v;
            select.appendChild(option);
        });
    }      

    // Cargar reportes al hacer clic en el bot√≥n
    async function consultarReporteFallas() {
        const fecha = document.getElementById("filtroFecha").value;
        if (!fecha) {
            alert("Por favor, selecciona una fecha de reporte.");
            document.getElementById("filtroFecha").focus();
            return;
        }
    
        // Solo agrega filtros que tienen valor
        const params = new URLSearchParams();
        params.append("fecha", fecha);
    
        const placa = document.getElementById("filtroPlaca").value;
        if (placa) params.append("placa", placa);
    
        const tipo = document.getElementById("filtroTipoVehiculo").value;
        if (tipo) params.append("tipo_vehiculo", tipo);
    
        const marca = document.getElementById("filtroMarca").value;
        if (marca) params.append("marca", marca);
    
        const estado = document.getElementById("filtroEstado").value;
        if (estado) params.append("estado", estado);
    
        const usuario = document.getElementById("filtroUsuario").value;
        if (usuario) params.append("usuario", usuario);
    
        const contenedor = document.getElementById("contenedorResultados");
        contenedor.innerHTML = "<div class='text-muted'>üîÑ Consultando resultados...</div>";
    
        try {
            const res = await fetch(`/reportes/fallas?${params.toString()}`);
            const datos = await res.json();
    
            if (datos.length === 0) {
                contenedor.innerHTML = "<div class='alert alert-warning p-2'>No se encontraron resultados.</div>";
                return;
            }
    
            let tabla = `<div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                <table class="table table-bordered table-sm" style="font-size: 12px;">
                <thead class="encabezado-reporte sticky-top">
                    <tr>
                        <th>ID Checklist</th><th>Fecha Reporte</th><th>Placa</th><th>Tipo Veh√≠culo</th><th>Marca</th><th>L√≠nea</th>
                        <th>Modelo</th><th>Inicio Turno</th><th>Fin Turno</th><th>Km Od√≥metro</th>
                        <th>Observaci√≥n General</th><th>Tipo</th><th>Grupo</th><th>Posici√≥n</th>
                        <th>Componente</th><th>Observaci√≥n</th><th>Registrado por</th><th>Estado</th><th>Fecha Guardado</th>
                    </tr>
                </thead>
                <tbody>`;
    
            datos.forEach(row => {
                tabla += `<tr>
                    <td>${row.id_checklist}</td>
                    <td>${row.fecha_reporte}</td>
                    <td>${row.placa}</td>
                    <td>${row.tipo_vehiculo}</td>
                    <td>${row.marca}</td>
                    <td>${row.linea}</td>
                    <td>${row.modelo}</td>
                    <td>${row.inicio_turno}</td>
                    <td>${row.fin_turno}</td>
                    <td>${row.km_odometro}</td>
                    <td>${row.observaciones_generales || ''}</td>
                    <td>${row.tipo}</td>
                    <td>${row.grupo || ''}</td>
                    <td>${row.posicion || ''}</td>
                    <td>${row.componente || ''}</td>
                    <td>${row.observaciones || ''}</td>
                    <td>${row.usuario_registro}</td>
                    <td>
                    ${row.estado_item === false
                        ? '<span class="badge bg-danger">‚ùå Falla</span>'
                        : '<span class="badge bg-success">‚úîÔ∏è OK</span>'}
                    </td>
                    <td>${row.fecha_guardado}</td>
                </tr>`;
            });
    
            tabla += "</tbody></table></div>";
            contenedor.innerHTML = tabla;

            document.getElementById("botonesDescarga").style.display = "block";

        } catch (err) {
            console.error("Error al consultar:", err);
            contenedor.innerHTML = "<div class='alert alert-danger p-2'>Error al consultar el reporte.</div>";
        }
    }

    function descargarReporte(formato) {
        const fecha = document.getElementById("filtroFecha").value;
        if (!fecha) {
            alert("Primero realiza una consulta con fecha.");
            return;
        }
    
        const params = new URLSearchParams();
        params.append("fecha", fecha);
    
        const filtros = {
            placa: "filtroPlaca",
            tipo_vehiculo: "filtroTipoVehiculo",
            marca: "filtroMarca",
            estado: "filtroEstado",
            usuario: "filtroUsuario"
        };
    
        for (const [key, id] of Object.entries(filtros)) {
            const val = document.getElementById(id).value;
            if (val) params.append(key, val);
        }
    
        window.open(`/reportes/fallas/exportar?${params.toString()}&formato=${formato}`, '_blank');
    }    
    
</script>

{% endblock %}